"""
Streamlit –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ—Ä—Ä–∞–∑–∏—Ç–æ–≤–æ–π —à—Ç—É–∫–∞—Ç—É—Ä–∫–∏
"""
import streamlit as st
import pandas as pd
import json
import plotly.express as px
import plotly.graph_objects as go
from pathlib import Path
import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º scripts –≤ –ø—É—Ç—å –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞
sys.path.append('scripts')

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
st.set_page_config(
    page_title="Terrazite Plaster AI",
    page_icon="üß±",
    layout="wide",
    initial_sidebar_state="expanded"
)

# –ó–∞–≥–æ–ª–æ–≤–æ–∫
st.title("üß± Terrazite Plaster AI - Recipe Analyzer")
st.markdown("""
–ê–Ω–∞–ª–∏–∑ —Ä–µ—Ü–µ–ø—Ç–æ–≤ —Ç–µ—Ä—Ä–∞–∑–∏—Ç–æ–≤–æ–π —à—Ç—É–∫–∞—Ç—É—Ä–∫–∏ –∏ –ø–æ–¥–±–æ—Ä —Å–æ—Å—Ç–∞–≤–∞ –ø–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –æ–±—Ä–∞–∑—Ü–∞.
""")

# –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å
with st.sidebar:
    st.header("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏")
    
    # –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã
    mode = st.radio(
        "–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã:",
        ["üìä –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö", "üì∑ –ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ", "üß™ –ü–æ–¥–±–æ—Ä —Ä–µ—Ü–µ–ø—Ç–∞"]
    )
    
    st.divider()
    
    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞–Ω–Ω—ã—Ö
    st.subheader("üìÅ –î–∞–Ω–Ω—ã–µ")
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–æ–≤
    data_path = Path("data/processed/recipes.json")
    if data_path.exists():
        st.success("‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã")
        with open(data_path, 'r', encoding='utf-8') as f:
            data = json.load(f)
        st.info(f"üìä –†–µ—Ü–µ–ø—Ç–æ–≤: {len(data)}")
    else:
        st.warning("‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
        if st.button("üîÑ –û–±—Ä–∞–±–æ—Ç–∞—Ç—å Excel"):
            # –ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ Excel
            import subprocess
            with st.spinner("–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö..."):
                result = subprocess.run([sys.executable, "scripts/process_excel.py"], 
                                      capture_output=True, text=True)
                if result.returncode == 0:
                    st.success("‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã!")
                    st.rerun()
                else:
                    st.error(f"‚ùå –û—à–∏–±–∫–∞: {result.stderr}")
    
    st.divider()
    st.caption("–í–µ—Ä—Å–∏—è 1.0 | Terrazite AI")

# –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
if mode == "üìä –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö":
    st.header("üìä –ê–Ω–∞–ª–∏–∑ –±–∞–∑—ã —Ä–µ—Ü–µ–ø—Ç–æ–≤")
    
    # –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    try:
        with open("data/processed/recipes.json", 'r', encoding='utf-8') as f:
            recipes = json.load(f)
        
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ DataFrame –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        data_for_df = []
        for recipe in recipes:
            row = {
                'ID': recipe['id'],
                '–ù–∞–∑–≤–∞–Ω–∏–µ': recipe['name'],
                '–¢–∏–ø': recipe['type'],
                '–í—Å–µ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤': len([v for v in recipe['components'].values() if v > 0])
            }
            # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ø-5 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
            sorted_comps = sorted(recipe['components'].items(), key=lambda x: x[1], reverse=True)[:5]
            for i, (comp, value) in enumerate(sorted_comps):
                row[f'–ö–æ–º–ø–æ–Ω–µ–Ω—Ç {i+1}'] = f"{comp[:15]}... ({value} –∫–≥)" if value > 0 else ""
            
            data_for_df.append(row)
        
        df = pd.DataFrame(data_for_df)
        
        # –ü–æ–∫–∞–∑–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É
        st.subheader("üìã –¢–∞–±–ª–∏—Ü–∞ —Ä–µ—Ü–µ–ø—Ç–æ–≤")
        st.dataframe(df, use_container_width=True, height=400)
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        col1, col2, col3 = st.columns(3)
        with col1:
            st.metric("–í—Å–µ–≥–æ —Ä–µ—Ü–µ–ø—Ç–æ–≤", len(recipes))
        with col2:
            terrazite_count = sum(1 for r in recipes if r['type'] == '—Ç–µ—Ä—Ä–∞–∑–∏—Ç')
            st.metric("–¢–µ—Ä—Ä–∞–∑–∏—Ç—ã", terrazite_count)
        with col3:
            seam_count = sum(1 for r in recipes if r['type'] == '—à–æ–≤–Ω—ã–π')
            st.metric("–®–æ–≤–Ω—ã–µ", seam_count)
        
        # –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
        st.subheader("üìà –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö")
        
        # 1. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–æ–≤
        fig1 = px.pie(
            names=['–¢–µ—Ä—Ä–∞–∑–∏—Ç—ã', '–®–æ–≤–Ω—ã–µ'],
            values=[terrazite_count, seam_count],
            title='–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ —Ä–µ—Ü–µ–ø—Ç–æ–≤'
        )
        st.plotly_chart(fig1, use_container_width=True)
        
        # 2. –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        component_counts = [row['–í—Å–µ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤'] for row in data_for_df]
        fig2 = px.histogram(
            x=component_counts,
            nbins=10,
            title='–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤',
            labels={'x': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤', 'y': '–ß–∞—Å—Ç–æ—Ç–∞'}
        )
        st.plotly_chart(fig2, use_container_width=True)
        
    except FileNotFoundError:
        st.error("–§–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω. –û–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ Excel —Ñ–∞–π–ª —Å–Ω–∞—á–∞–ª–∞.")

elif mode == "üì∑ –ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ":
    st.header("üì∑ –ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –æ–±—Ä–∞–∑—Ü–∞")
    
    # –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    uploaded_file = st.file_uploader(
        "–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ –æ–±—Ä–∞–∑—Ü–∞ —à—Ç—É–∫–∞—Ç—É—Ä–∫–∏",
        type=['jpg', 'jpeg', 'png'],
        help="–§–æ—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–¥–µ–ª–∞–Ω–æ –ø—Ä–∏ —Ö–æ—Ä–æ—à–µ–º –æ—Å–≤–µ—â–µ–Ω–∏–∏"
    )
    
    if uploaded_file is not None:
        # –ü–æ–∫–∞–∑–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        col1, col2 = st.columns(2)
        
        with col1:
            st.image(uploaded_file, caption="–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ", use_column_width=True)
            
            # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ
            file_size = uploaded_file.size / 1024  # KB
            st.caption(f"–†–∞–∑–º–µ—Ä: {file_size:.1f} KB")
        
        with col2:
            st.subheader("üé® –ê–Ω–∞–ª–∏–∑ —Ü–≤–µ—Ç–∞")
            
            # –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ü–≤–µ—Ç–∞
            st.info("""
            **–ê–Ω–∞–ª–∏–∑ —Ü–≤–µ—Ç–∞ (–∑–∞–≥–ª—É—à–∫–∞):**
            - –û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç: –ë–µ–∂–µ–≤—ã–π (RGB: 200, 180, 160)
            - –¶–≤–µ—Ç–æ–≤–∞—è –≥–∞–º–º–∞: –¢–µ–ø–ª—ã–µ —Ç–æ–Ω–∞
            - –ö–æ–Ω—Ç—Ä–∞—Å—Ç: –°—Ä–µ–¥–Ω–∏–π
            """)
            
            # –¶–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞
            colors = ['#C8B4A0', '#B0A090', '#987868', '#786048']
            fig = go.Figure(data=[go.Bar(
                x=['–¶–≤–µ—Ç 1', '–¶–≤–µ—Ç 2', '–¶–≤–µ—Ç 3', '–¶–≤–µ—Ç 4'],
                y=[1, 0.8, 0.6, 0.4],
                marker_color=colors
            )])
            fig.update_layout(title="–¶–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞ –æ–±—Ä–∞–∑—Ü–∞", height=300)
            st.plotly_chart(fig, use_container_width=True)
        
        # –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç—É—Ä—ã
        st.subheader("üîÑ –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç—É—Ä—ã")
        
        col3, col4 = st.columns(2)
        
        with col3:
            st.selectbox(
                "–¢–∏–ø –∑–∞–ø–æ–ª–Ω–∏—Ç–µ–ª—è:",
                ["–ú—Ä–∞–º–æ—Ä", "–ö–≤–∞—Ä—Ü", "–ì—Ä–∞–Ω–∏—Ç", "–°–ª—é–¥–∞", "–ò–∑–≤–µ—Å—Ç–Ω—è–∫"],
                index=0
            )
        
        with col4:
            st.select_slider(
                "–†–∞–∑–º–µ—Ä —Ñ—Ä–∞–∫—Ü–∏–∏:",
                options=["–ú–µ–ª–∫–∞—è (0-2 –º–º)", "–°—Ä–µ–¥–Ω—è—è (2-5 –º–º)", "–ö—Ä—É–ø–Ω–∞—è (5-10 –º–º)"],
                value="–°—Ä–µ–¥–Ω—è—è (2-5 –º–º)"
            )
        
        # –ö–Ω–æ–ø–∫–∞ –∞–Ω–∞–ª–∏–∑–∞
        if st.button("üß™ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–∑–µ—Ü", type="primary"):
            with st.spinner("–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ..."):
                # –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
                import time
                time.sleep(2)
                
                # –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞
                st.success("‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!")
                
                # –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                results_col1, results_col2, results_col3 = st.columns(3)
                
                with results_col1:
                    st.metric("–¢–æ—á–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞", "85%", "5%")
                
                with results_col2:
                    st.metric("–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø–æ–ª–Ω–∏—Ç–µ–ª—å", "–ú—Ä–∞–º–æ—Ä", "")
                
                with results_col3:
                    st.metric("–§—Ä–∞–∫—Ü–∏—è", "2-5 –º–º", "")

elif mode == "üß™ –ü–æ–¥–±–æ—Ä —Ä–µ—Ü–µ–ø—Ç–∞":
    st.header("üß™ –ü–æ–¥–±–æ—Ä —Ä–µ—Ü–µ–ø—Ç–∞ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º")
    
    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø–æ–¥–±–æ—Ä–∞
    col1, col2 = st.columns(2)
    
    with col1:
        aggregate_type = st.selectbox(
            "–¢–∏–ø –∑–∞–ø–æ–ª–Ω–∏—Ç–µ–ª—è:",
            ["–ú—Ä–∞–º–æ—Ä", "–ö–≤–∞—Ä—Ü", "–ì—Ä–∞–Ω–∏—Ç", "–°–ª—é–¥–∞", "–ò–∑–≤–µ—Å—Ç–Ω—è–∫", "–°–º–µ—à–∞–Ω–Ω—ã–π"]
        )
        
        fraction_size = st.select_slider(
            "–†–∞–∑–º–µ—Ä —Ñ—Ä–∞–∫—Ü–∏–∏:",
            options=["0-1 –º–º", "1-2 –º–º", "2-3 –º–º", "3-5 –º–º", "5-7 –º–º"],
            value="2-3 –º–º"
        )
    
    with col2:
        base_color = st.color_picker("–ë–∞–∑–æ–≤—ã–π —Ü–≤–µ—Ç:", "#C8B4A0")
        
        cement_type = st.radio(
            "–¢–∏–ø —Ü–µ–º–µ–Ω—Ç–∞:",
            ["–ë–µ–ª—ã–π", "–°–µ—Ä—ã–π", "–°–º–µ—Å—å"]
        )
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    with st.expander("–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã"):
        col3, col4 = st.columns(2)
        
        with col3:
            sand_amount = st.slider("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Å–∫–∞ (%):", 30, 70, 45)
            pigment_amount = st.slider("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∏–≥–º–µ–Ω—Ç–∞ (%):", 0.1, 5.0, 1.5, 0.1)
        
        with col4:
            additives = st.multiselect(
                "–î–æ–±–∞–≤–∫–∏:",
                ["–ü–ª–∞—Å—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –°3", "–ú–µ—Ç–∏–ª—Ü–µ–ª–ª—é–ª–æ–∑–∞", "–†–ü–ü", "–ö—Ä–∞—Ö–º–∞–ª—å–Ω—ã–π —ç—Ñ–∏—Ä", "–ü–æ—Ä–æ–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å"]
            )
    
    # –ö–Ω–æ–ø–∫–∞ –ø–æ–¥–±–æ—Ä–∞
    if st.button("üîç –ü–æ–¥–æ–±—Ä–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç—ã", type="primary"):
        with st.spinner("–ò—â–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —Ä–µ—Ü–µ–ø—Ç—ã..."):
            # –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –ø–æ–¥–±–æ—Ä–∞
            import time
            time.sleep(1.5)
            
            # –ü—Ä–∏–º–µ—Ä–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            st.success("‚úÖ –ù–∞–π–¥–µ–Ω–æ 3 –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ä–µ—Ü–µ–ø—Ç–∞!")
            
            # –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            results_data = {
                "–†–µ—Ü–µ–ø—Ç": ["–¢–µ—Ä—Ä–∞–∑–∏—Ç –ö62–ê", "–¢–µ—Ä—Ä–∞–∑–∏—Ç –ú–®1", "–¢–µ—Ä—Ä–∞–∑–∏—Ç –ú-6"],
                "–°–æ–≤–ø–∞–¥–µ–Ω–∏–µ": ["92%", "87%", "78%"],
                "–¶–µ–º–µ–Ω—Ç": ["–ë–µ–ª—ã–π 100–∫–≥ + –°–µ—Ä—ã–π 150–∫–≥", "–ë–µ–ª—ã–π 230–∫–≥ + –°–µ—Ä—ã–π 15–∫–≥", "–ë–µ–ª—ã–π 80–∫–≥ + –°–µ—Ä—ã–π 120–∫–≥"],
                "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ–ª—å": ["–ú—Ä–∞–º–æ—Ä 300–∫–≥", "–ú—Ä–∞–º–æ—Ä 160–∫–≥", "–ú—Ä–∞–º–æ—Ä 340–∫–≥"],
                "–ü–µ—Å–æ–∫": ["342–∫–≥", "482–∫–≥", "299–∫–≥"],
                "–î–æ–±–∞–≤–∫–∏": ["–ú–µ—Ç–∏–ª—Ü–µ–ª–ª—é–ª–æ–∑–∞ 7–∫–≥", "–ú–µ—Ç–∏–ª—Ü–µ–ª–ª—é–ª–æ–∑–∞ 7–∫–≥", "–ú–µ—Ç–∏–ª—Ü–µ–ª–ª—é–ª–æ–∑–∞ 5–∫–≥"]
            }
            
            results_df = pd.DataFrame(results_data)
            st.dataframe(results_df, use_container_width=True)
            
            # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
            st.subheader("üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è")
            st.info("""
            **–õ—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç: –¢–µ—Ä—Ä–∞–∑–∏—Ç –ö62–ê**
            
            –ü—Ä–∏—á–∏–Ω—ã:
            1. –ù–∞–∏–≤—ã—Å—à–µ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º (92%)
            2. –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ü–µ–º–µ–Ω—Ç/–∑–∞–ø–æ–ª–Ω–∏—Ç–µ–ª—å
            3. –ü–æ–¥—Ö–æ–¥—è—â–∞—è —Ñ—Ä–∞–∫—Ü–∏—è –º—Ä–∞–º–æ—Ä–∞ (2-3 –º–º)
            4. –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–±–∞–≤–æ–∫
            """)

# –§—É—Ç–µ—Ä
st.divider()
st.caption("""
¬© 2024 Terrazite Plaster AI | –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∑–∞–≥—Ä—É–∑–∏—Ç–µ Excel —Ñ–∞–π–ª —Å —Ä–µ—Ü–µ–ø—Ç–∞–º–∏ –≤ –ø–∞–ø–∫—É data/raw/
""")
